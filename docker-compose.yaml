name: wbs-deploy

services:
  # --------------------------------------------------
  # A. CORE WIKIBASE SUITE SERVICES
  # --------------------------------------------------

# sudo docker run -d --rm --name wikibase-metadata  -p 80:8000 wikibase-metadata

  backend:
    image: wikibase-metadata
    build:
      dockerfile: ./Dockerfile      
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wikibase-metadata.rule=Host(`wikibase-metadata.docker.localhost`) && !PathPrefix(`/graphql`)"
    volumes:
      - /var/local/wikidev/settings.ini:/app/settings.ini
      - /var/local/wikidev/db/:/app/db/
      - /var/local/wikidev/logs/:/app/logs/
    environment:

    # healthcheck:
    #   test: curl --silent --fail localhost/graphql
    #   interval: 10s
    #   start_period: 5m

  frontend:
    image: wikibase-metadata-frontend
    build:
      context: frontend
      dockerfile: ./frontend/Dockerfile      
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wikibase-metadata.rule=Host(`wikibase-metadata.docker.localhost`)"
    # volumes:
    #   - /var/local/wikidev/settings.ini:/app/settings.ini
    #   - /var/local/wikidev/db/:/app/db/
    #   - /var/local/wikidev/logs/:/app/logs/
    # environment:

    # healthcheck:
    #   test: curl --silent --fail localhost/graphql
    #   interval: 10s
    #   start_period: 5m



  # This is the reverse proxy and SSL service
  traefik:
    image: traefik:3
    command:
      # Basic setup
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      # http endpoint
      - "--entrypoints.web.address=:80"
      # # https endpoint
      # - "--entrypoints.websecure.address=:443"
      # - "--entrypoints.websecure.asdefault"
      # - "--entrypoints.websecure.http.tls.certresolver=letsencrypt"
      # # http to https redirect
      # - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      # - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      # - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      # # ACME SSL certificate generation
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      # - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # - "--certificatesresolvers.letsencrypt.acme.email=${MW_ADMIN_EMAIL}"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

      # Uncomment this line to only test ssl generation first, makes sure you don't run into letsencrypt rate limits
      # - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
    restart: unless-stopped
    ports:
      - 80:80
      # - 443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # - traefik-letsencrypt-data:/letsencrypt

# volumes:
#   traefik-letsencrypt-data:
